server:
  port: 8080

spring:
  application:
    name: gamevault-gateway

  cloud:
    nacos:
      discovery:
        server-addr: ${SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR:nacos:8848}
        namespace: ${SPRING_CLOUD_NACOS_DISCOVERY_NAMESPACE:prod}
        group: GAMEVAULT_GROUP
        enabled: true
        register-enabled: true
        ip: ${POD_IP:}
      config:
        enabled: false
      import-check:
        enabled: false

    gateway:
      # ==================== 路由配置 ====================
      routes:
        # ==================== OPTIONS 预检（必须在最前面）====================
        - id: cors-options
          uri: no://op
          order: -1
          predicates:
            - Method=OPTIONS
          filters:
            - SetStatus=200
            - AddResponseHeader=Access-Control-Allow-Origin,*
            - AddResponseHeader=Access-Control-Allow-Methods,GET,POST,PUT,DELETE,OPTIONS,PATCH
            - AddResponseHeader=Access-Control-Allow-Headers,*
            - AddResponseHeader=Access-Control-Allow-Credentials,true
            - AddResponseHeader=Access-Control-Max-Age,3600

        # ==================== 认证服务 ====================
        - id: auth-service
          uri: lb://gamevault-auth
          predicates:
            - Path=/api/auth/**,/.well-known/jwks.json,/api/settings/**,/uploads/**
          filters:
            - StripPrefix=0
            - AddResponseHeader=Access-Control-Allow-Origin,*
            - AddResponseHeader=Access-Control-Allow-Credentials,true

        # ==================== Shopping 服务 ====================
        - id: shopping-service
          uri: lb://gamevault-shopping
          predicates:
            - Path=/api/games/**,/api/library/**,/api/cart/**,/api/orders/**,/api/admin/games/**,/api/user/activation-codes/**
          filters:
            - StripPrefix=0
            - AddResponseHeader=Access-Control-Allow-Origin,*
            - AddResponseHeader=Access-Control-Allow-Credentials,true

        # ==================== Developer 服务 ====================
        - id: developer-service
          uri: lb://gamevault-developer
          predicates:
            - Path=/api/developer/**
          filters:
            - StripPrefix=0
            - AddResponseHeader=Access-Control-Allow-Origin,*
            - AddResponseHeader=Access-Control-Allow-Credentials,true


        # ==================== WebSocket 服务 ====================
        - id: social-websocket
          uri: lb:ws://gamevault-social
          predicates:
            - Path=/ws/info/**,/ws/**
          filters:
            - StripPrefix=0

        # ==================== Social 服务 ====================
        - id: social-service
          uri: lb://gamevault-social
          predicates:
            - Path=/api/conversation/**,/api/friend/**,/api/message/**,/api/file/**
          filters:
            - StripPrefix=0
            - AddResponseHeader=Access-Control-Allow-Origin,*
            - AddResponseHeader=Access-Control-Allow-Credentials,true

        # ==================== Forum 服务 ====================
        - id: forum-service
          uri: lb://gamevault-forum
          predicates:
            - Path=/api/forum/**
          filters:
            - StripPrefix=0
            - AddResponseHeader=Access-Control-Allow-Origin,*
            - AddResponseHeader=Access-Control-Allow-Credentials,true
        # ==================== Profile 服务 ====================
        - id: profile-service
          uri: lb://gamevault-profile
          predicates:
            - Path=/api/settings/**,/api/profile/**
          filters:
            - StripPrefix=0
            - AddResponseHeader=Access-Control-Allow-Origin,*
            - AddResponseHeader=Access-Control-Allow-Credentials,true

      # ==================== 全局 CORS 配置 ====================

# ==================== Actuator ====================
management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway,routes,metrics
  endpoint:
    health:
      show-details: when-authorized

# ==================== 日志配置 ====================
logging:
  level:
    org.springframework.cloud.gateway: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: /app/logs/gamevault-gateway.log
